<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>PID Dashboard</title>
  
  <!-- META TAGY PRO FULLSCREEN A WEB APP -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <!-- Odkaz na manifest (TOTO SCHOVÁ LIŠTU V CHROME) -->
  <link rel="manifest" href="manifest.json">
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">

  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta http-equiv="refresh" content="10800">

  <style>
    /* === ZÁKLADNÍ DESKTOP STYLY === */
    body { background-color: #050505; color: #FFFFFF; font-family: sans-serif; margin: 0; padding: 16px; height: 100vh; overflow: hidden; box-sizing: border-box; }
    
    /* === BARVY === */
    :root {
      --bg-color: #050505;
      --panel-bg: #111111;
      --border-color: #262626;
      --accent-bus: #3B82F6; 
      --accent-metro: #E11D2D; 
      --text-main: #FFFFFF;
      --text-sec: #888888;
      
      /* NOVÁ ŽLUTÁ PRO ZPOŽDĚNÍ */
      --status-warn: #FFCC00; 
      --status-alert: #EF4444;
    }

    header { display: -webkit-flex; display: flex; -webkit-justify-content: space-between; justify-content: space-between; -webkit-align-items: flex-end; align-items: flex-end; border-bottom: 1px solid #262626; padding-bottom: 20px; margin-bottom: 20px; position: relative; }
    
    .header-left { display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; }
    .header-left h1 { margin: 0; font-size: 1rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    
    .date-row { display: -webkit-flex; display: flex; -webkit-align-items: center; align-items: center; }
    .date-large { font-size: 1.8rem; font-weight: bold; margin-top: 5px; color: #eee; white-space: nowrap; }
    
    .weather-wrap { display: -webkit-flex; display: flex; -webkit-align-items: center; align-items: center; margin-left: 20px; padding-left: 20px; border-left: 1px solid #333; height: 30px; opacity: 1; }
    .weather-icon { width: 32px; height: 32px; margin-right: 8px; font-size: 24px; line-height: 32px; }
    .weather-icon svg { width: 100%; height: 100%; }
    .weather-text { display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; }
    .weather-temp { font-size: 1.2rem; font-weight: bold; color: #fff; line-height: 1; }
    .weather-desc { color: #888; font-size: 0.8rem; text-transform: lowercase; line-height: 1; margin-top: 2px; }
    
    .clock { font-size: 2.5rem; font-weight: bold; color: #fff; }

    .refresh-bar {
      position: absolute; bottom: -1px; left: 0; height: 2px;
      background: #FFFFFF; width: 0%;
      transition: width 1s linear; opacity: 0.8;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.4); 
    }

    .grid { display: -webkit-flex; display: flex; width: 100%; height: calc(100% - 120px); }
    .panel { -webkit-flex: 1; flex: 1; background: #111; border: 1px solid #222; border-radius: 12px; margin: 0 10px; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; overflow: hidden; }
    
    .panel-head { padding: 15px; border-bottom: 1px solid #222; background: #1a1a1a; display: -webkit-flex; display: flex; -webkit-align-items: center; align-items: center; }
    .icon-box { width: 24px; height: 24px; margin-right: 10px; }
    .icon-box svg { width: 100%; height: 100%; fill: currentColor; }
    .bus .icon-box { color: #3B82F6; }
    .metro .icon-box { color: #E11D2D; }
    .panel-title { font-weight: bold; font-size: 1rem; text-transform: uppercase; color: #fff; }
    
    .list-container { -webkit-flex: 1; flex: 1; overflow-y: hidden; padding: 5px 0; }
    table { width: 100%; border-collapse: collapse; }
    tr { height: 60px; border-bottom: 1px solid #222; }
    td { padding: 0 10px; vertical-align: middle; }
    
    .badge { background: #222; color: #fff; padding: 0; border-radius: 4px; font-weight: bold; font-size: 1.1rem; display: inline-block; width: 48px; height: 32px; line-height: 32px; text-align: center; }
    .bus .badge { background: #3B82F6; }
    .metro .badge { background: #E11D2D; }
    
    .td-dest { font-size: 1.1rem; font-weight: bold; color: #ddd; }
    .td-time { text-align: right; width: 100px; }
    
    .countdown-wrap { display: -webkit-flex; display: flex; -webkit-justify-content: flex-end; justify-content: flex-end; -webkit-align-items: baseline; align-items: baseline; }
    .val { font-size: 1.4rem; font-weight: bold; }
    .unit { font-size: 0.8rem; color: #888; margin-left: 3px; }
    .real-time { font-size: 0.8rem; color: #666; margin-top: 2px; }
    
    .sched-time { font-weight: bold; color: #ccc; font-size: 1rem; }

    /* === STYLY ZPOŽDĚNÍ (ŽLUTÁ) === */
    .status-now .val { color: #E11D2D; }
    .status-soon .val { color: var(--status-warn); }
    
    .delay-pill { 
        font-size: 0.75rem; 
        font-weight: 800; 
        color: #000; /* Černé písmo pro kontrast */
        background-color: var(--status-warn); /* Žluté pozadí */
        margin-left: 6px; 
        padding: 2px 5px; 
        border-radius: 4px;
        display: inline-block;
        vertical-align: middle;
    }

    #error-console { 
        position: absolute; top: 0; left: 0; width: 100%; background: #900; color: white; 
        font-size: 14px; padding: 15px; display: none; z-index: 9999; font-family: monospace; white-space: pre-wrap;
    }

    /* === MOBILNÍ ZOBRAZENÍ (Portrait - Telefon) === */
    @media (max-width: 900px) {
        body { padding: 10px; overflow-y: auto; height: auto; }
        
        header { -webkit-flex-direction: column; flex-direction: column; -webkit-align-items: flex-start; align-items: flex-start; }
        .clock { position: absolute; top: 0; right: 0; font-size: 1.8rem; margin-top: 0; }
        
        .date-row { -webkit-flex-direction: column; flex-direction: column; -webkit-align-items: flex-start; align-items: flex-start; }
        .date-large { font-size: 1.5rem; }
        
        .weather-wrap { margin-left: 0; padding-left: 0; border-left: none; margin-top: 10px; height: auto; }
        
        .grid { -webkit-flex-direction: column; flex-direction: column; height: auto; display: block; }
        .panel { margin: 0 0 20px 0; height: 380px; }
    }

    /* === OPRAVA PRO TABLET NA ŠÍŘKU (Landscape) === */
    @media (max-width: 900px) and (orientation: landscape) {
        body { 
            overflow: hidden; 
            padding: 12px;
            height: 100vh;
        }

        header {
            -webkit-flex-direction: row; flex-direction: row;
            -webkit-align-items: flex-end; align-items: flex-end;
            padding-bottom: 15px; margin-bottom: 15px;
        }
        
        .clock {
            position: relative; top: auto; right: auto; margin: 0;
            font-size: 2.2rem;
        }

        .date-row {
            -webkit-flex-direction: row; flex-direction: row;
            -webkit-align-items: center; align-items: center;
        }
        .date-large { font-size: 1.5rem; margin-top: 0; }

        .weather-wrap {
            margin-left: 15px; padding-left: 15px; 
            border-left: 1px solid #333; margin-top: 0;
            height: 30px;
        }

        .grid {
            display: -webkit-flex; display: flex;
            -webkit-flex-direction: row; flex-direction: row;
            height: calc(100% - 100px); 
        }

        .panel {
            -webkit-flex: 1; flex: 1;
            margin: 0 8px; 
            height: 100%;
        }
        
        .badge { width: 42px; font-size: 1rem; }
        .td-dest { font-size: 1rem; }
        .val { font-size: 1.3rem; }
    }
  </style>
</head>
<body>

  <div id="error-console"></div>

  <header>
    <div class="header-left">
      <h1 id="day-display">Načítám...</h1>
      <div class="date-row">
        <div id="date-display" class="date-large">...</div>
        <div class="weather-wrap" id="weather-box">
          <div id="weather-icon" class="weather-icon"></div>
          <div class="weather-text">
             <span id="weather-temp" class="weather-temp">--°</span>
             <span id="weather-desc" class="weather-desc"></span>
          </div>
        </div>
      </div>
    </div>
    <div id="clock" class="clock">--:--</div>
  </header>

  <div class="grid">
    <!-- PANEL BUS -->
    <div class="panel bus">
      <div class="panel-head">
        <div class="icon-box"><svg viewBox="0 0 24 24"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg></div>
        <span class="panel-title">Litochlebské nám.</span>
        <span id="err-bus" style="display:none; color:red; margin-left:auto; font-size:0.7rem; font-weight:bold;">NAČÍTÁM...</span>
      </div>
      <div class="list-container">
        <table><tbody id="tbody-bus"></tbody></table>
      </div>
    </div>

    <!-- PANEL METRO -->
    <div class="panel metro">
      <div class="panel-head">
        <div class="icon-box"><svg viewBox="0 0 24 24"><path d="M12 2c-4.42 0-8 .5-8 4v10c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4zM7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm3.5-6H6V6h5v5zm5.5 6c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6h-5V6h5v5z"/></svg></div>
        <span class="panel-title">Metro C – Opatov</span>
        <span id="err-metro" style="display:none; color:red; margin-left:auto; font-size:0.7rem; font-weight:bold;">NAČÍTÁM...</span>
      </div>
      <div class="list-container">
        <table><tbody id="tbody-metro"></tbody></table>
      </div>
    </div>
  </div>

  <script>
    // --- JS LOGIKA (ES6 kompatibilní, protože Chrome je aktualizovaný) ---

    window.onerror = function(msg, url, line) {
       var el = document.getElementById('error-console');
       if(el) {
           el.style.display = 'block';
           el.innerText = "JS Error: " + msg + " (Line " + line + ")";
       }
       return false;
    };

    const API_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NDE1NCwiaWF0IjoxNzYzMDQ0OTYyLCJleHAiOjExNzYzMDQ0OTYyLCJpc3MiOiJnb2xlbWlvIiwianRpIjoiYWI3ZTJlMjYtYmVjZS00MGNhLTlkYTItZGY1MzEzMjNmOTRhIn0.5P9OjGHaDP4wJ4f6w05fQZR1UARUgxk2gBuwDjpVrWU";
    const API_BASE = "https://api.golemio.cz/v2/pid/departureboards";
    const REFRESH_INTERVAL = 15000;
    
    const WEATHER_API = "https://api.open-meteo.com/v1/forecast?latitude=50.03&longitude=14.51&current_weather=true";
    
    let lastFetchTime = 0;

    const PANELS = [
      {
        id: 'bus',
        url: `${API_BASE}?ids=U344Z4P&limit=20&minutesAfter=90&preferredTimezone=Europe/Prague`,
        tbody: document.getElementById('tbody-bus'),
        errEl: document.getElementById('err-bus'),
        filter: function(d) { 
            var r = d.route; 
            if (!r) return false;
            var num = r.short_name || r.number;
            return ["177", "181", "182"].indexOf(num) !== -1;
        }
      },
      {
        id: 'metro',
        url: `${API_BASE}?names=Opatov&limit=50&minutesAfter=90&preferredTimezone=Europe/Prague`,
        tbody: document.getElementById('tbody-metro'),
        errEl: document.getElementById('err-metro'),
        filter: function(d) {
            var r = d.route; 
            var t = d.trip;
            if (!r || !t) return false;
            return r.short_name === "C" && t.headsign !== "Háje";
        }
      }
    ];

    const weatherIcons = {
      0: '<circle cx="12" cy="12" r="5" fill="#FDB813" /><g stroke="#FDB813" stroke-width="2"><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></g>',
      1: '<circle cx="10" cy="10" r="4" fill="#FDB813" /><path d="M18,19c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.7,19,18,19z" fill="#B0C4DE" />',
      2: '<path d="M17.5,19c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,19,17.5,19z" fill="#B0C4DE" opacity="0.8"/>',
      3: '<path d="M17.5,19c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,19,17.5,19z" fill="#9CA3AF"/>',
      61: '<path d="M17.5,17c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,17,17.5,17z" fill="#9CA3AF"/><line x1="8" y1="18" x2="7" y2="22" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="18" x2="11" y2="22" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/><line x1="16" y1="18" x2="15" y2="22" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/>',
      71: '<path d="M17.5,17c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,17,17.5,17z" fill="#B0C4DE"/><circle cx="8" cy="21" r="1.5" fill="white"/><circle cx="12" cy="20" r="1.5" fill="white"/><circle cx="16" cy="21" r="1.5" fill="white"/>',
      95: '<path d="M17.5,17c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,17,17.5,17z" fill="#6B7280"/><polygon points="11 17 9 21 11 21 10 24 14 20 12 20 13 17" fill="#FDB813"/>'
    };

    function formatHM(date) {
        var h = ("0" + date.getHours()).slice(-2);
        var m = ("0" + date.getMinutes()).slice(-2);
        return h + ":" + m;
    }

    function getDelayHTML(scheduled, predicted) {
      if (!scheduled || !predicted) return "";
      const diffMs = predicted - scheduled;
      const delayMin = Math.round(diffMs / 60000);
      if (delayMin === 0) return "";
      
      const sign = delayMin > 0 ? "+" : "";
      const cls = delayMin > 0 ? "delay-late" : "delay-early";
      return `<span class="delay-pill ${cls}">${sign}${delayMin} min</span>`;
    }

    async function fetchAndRender(panel) {
      try {
        const res = await fetch(panel.url, {
          headers: { "x-access-token": API_TOKEN, "Content-Type": "application/json" }
        });
        if (!res.ok) throw new Error(res.status);
        const json = await res.json();
        
        const rawData = json.departures || [];
        
        const data = rawData
          .filter(function(d) { try { return panel.filter(d); } catch(e) { return false; } })
          .map(function(d) {
            const ts = d.departure_timestamp || {};
            const sched = ts.scheduled ? new Date(ts.scheduled) : null;
            const pred = ts.predicted ? new Date(ts.predicted) : null;
            const eff = pred || sched;
            
            var line = "?";
            if (d.route) line = d.route.short_name || "?";
            
            var dest = "?";
            if (d.trip) dest = d.trip.headsign || "?";

            return {
              line: line, dest: dest,
              sched: sched, pred: pred, eff: eff,
              ts: eff ? eff.getTime() : 0 
            };
          })
          .filter(function(d) { return d.ts > 0; })
          .sort(function(a, b) { return a.ts - b.ts; })
          .slice(0, 7); 

        if (data.length === 0) {
          panel.tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Žádné spoje v dohledu</td></tr>';
        } else {
          panel.tbody.innerHTML = data.map(function(item) {
            const delayHtml = getDelayHTML(item.sched, item.pred);
            const schedTime = item.sched ? formatHM(item.sched) : "";
            
            return '<tr data-ts="' + item.ts + '">' +
              '<td class="td-line"><div class="badge">' + item.line + '</div></td>' +
              '<td class="td-dest">' + item.dest + '</td>' +
              '<td class="td-time">' +
                '<div class="countdown-wrap"><span class="val">--</span><span class="unit">min</span></div>' +
                '<div class="real-time">' + '<span class="sched-time">' + schedTime + '</span>' + delayHtml + '</div>' +
              '</td>' +
            '</tr>';
          }).join('');
        }
        panel.errEl.style.display = 'none';
        updateTimersInDom(panel.tbody);
      } catch (e) {
        console.error(panel.id, e);
        panel.errEl.style.display = 'inline-block';
      }
    }

    function loadWeather() {
        fetch(WEATHER_API)
        .then(res => res.json())
        .then(data => {
            if (data.current_weather) {
                var t = Math.round(data.current_weather.temperature);
                document.getElementById('weather-temp').innerText = t + "°";
                
                var code = data.current_weather.weathercode;
                var svg = W_ICONS[2]; 
                if (W_ICONS[code]) svg = W_ICONS[code];
                else {
                    if (code <= 1) svg = W_ICONS[0];
                    else if (code >= 51 && code <= 67) svg = W_ICONS[61];
                    else if (code >= 71 && code <= 77) svg = W_ICONS[71];
                    else if (code >= 95) svg = W_ICONS[95];
                }
                
                document.getElementById('weather-icon').innerHTML = '<svg viewBox="0 0 24 24">' + svg + '</svg>';
                
                var desc = "zataženo";
                if(code === 0) desc = "jasno";
                if(code === 1) desc = "polojasno";
                if(code > 50) desc = "srážky";
                document.getElementById('weather-desc').innerText = desc;
                document.getElementById('weather-box').style.opacity = 1;
            }
        })
        .catch(err => console.error(err));
    }

    function updateTimersInDom(tbody) {
        var now = new Date().getTime();
        var rows = tbody.querySelectorAll('tr[data-ts]');
        for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var targetTs = parseInt(row.getAttribute('data-ts'));
            var diffSec = Math.floor((targetTs - now) / 1000);
            var valEl = row.querySelector('.val');
            var unitEl = row.querySelector('.unit');
            
            valEl.style.color = "#ffffff";

            if (diffSec < -30) {
                row.style.display = 'none';
            } else {
                var text = "";
                var unit = "";
                if (diffSec <= 0) {
                    text = "TEĎ"; valEl.style.color = "#E11D2D";
                } else {
                    var m = Math.floor(diffSec / 60);
                    var s = diffSec % 60;
                    if (m === 0) {
                        text = s; unit = "s"; valEl.style.color = "#E11D2D";
                    } else {
                        text = m; unit = "min";
                        if (m < 5) valEl.style.color = "#F59E0B";
                    }
                }
                valEl.innerText = text;
                unitEl.innerText = unit;
            }
        }
    }

    function updateProgressBar() {
        const now = Date.now();
        const elapsed = now - lastFetchTime;
        const progress = Math.min((elapsed / REFRESH_INTERVAL) * 100, 100);
        document.getElementById('refresh-bar').style.width = progress + '%';
    }

    function tick() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('cs-CZ', {
          hour: '2-digit', minute:'2-digit', second: '2-digit'
      });
      
      const dayName = now.toLocaleDateString('cs-CZ', { weekday: 'long' });
      const fullDate = now.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric', year: 'numeric' });
      
      document.getElementById('day-display').textContent = dayName;
      document.getElementById('date-display').textContent = fullDate;

      updateTimersInDom(document.getElementById('tbody-bus'));
      updateTimersInDom(document.getElementById('tbody-metro'));
      
      updateProgressBar();
    }

    async function dataLoop() { 
        lastFetchTime = Date.now();
        await Promise.all(PANELS.map(fetchAndRender)); 
    }

    // INIT
    tick();
    dataLoop();
    loadWeather();

    setInterval(tick, 1000);
    setInterval(dataLoop, REFRESH_INTERVAL); 
    setInterval(loadWeather, 900000);

  </script>
</body>
</html>
