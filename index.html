<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>PID Dashboard</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">

  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta http-equiv="refresh" content="10800">

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    /* === ZÁKLADNÍ STYLY === */
    :root {
      --bg-color: #050505;
      --panel-bg: #111111;
      --border-color: #262626;
      --accent-bus: #3B82F6; 
      --accent-metro: #E11D2D; 
      --text-main: #FFFFFF;
      --text-sec: #888888;
      --status-warn: #FFCC00; 
      --status-alert: #EF4444;
    }

    body { 
        background-color: var(--bg-color); 
        color: var(--text-main); 
        font-family: 'Inter', sans-serif; 
        margin: 0; 
        padding: 15px; 
        /* Fixní výška pro chování jako aplikace */
        height: 100vh; 
        height: 100dvh; /* Pro moderní mobilní prohlížeče */
        overflow: hidden; 
        box-sizing: border-box; 
        display: flex;
        flex-direction: column;
    }
    
    /* HEADER - Kompaktnější verze */
    header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        border-bottom: 1px solid var(--border-color); 
        padding-bottom: 10px; 
        margin-bottom: 10px; 
        flex: 0 0 auto; /* Header se nenatahuje */
    }
    
    .header-left { 
        display: flex; 
        flex-direction: column; 
        justify-content: center;
    }
    
    .header-main-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .header-left h1 { 
        margin: 0; font-size: 0.85rem; color: var(--text-sec); 
        text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; 
    }
    
    .date-large { 
        font-size: 1.5rem; font-weight: bold; color: #eee; white-space: nowrap; 
    }
    
    /* === POČASÍ === */
    .weather-wrap { 
        display: flex; 
        align-items: center; 
        padding-left: 20px; 
        border-left: 1px solid #333; 
        margin-left: 20px;
        opacity: 1; 
    }
    
    .weather-icon { width: 42px; height: 42px; margin-right: 10px; }
    .weather-icon svg { width: 100%; height: 100%; }
    
    .weather-text { display: flex; flex-direction: column; justify-content: center; }
    
    .weather-temp { 
        font-size: 1.8rem; font-weight: bold; color: #fff; line-height: 1; 
    }
    .weather-desc { 
        color: #888; font-size: 0.8rem; text-transform: lowercase; margin-top: 2px; 
    }
    
    .clock { 
        font-size: 2.5rem; font-weight: bold; color: #fff; 
        font-variant-numeric: tabular-nums; /* Aby čísla neposkakovala */
        white-space: nowrap;
    }

    /* === GRID & PANELY === */
    .grid { 
        display: flex; 
        flex: 1; /* Zabere zbytek výšky stránky */
        gap: 15px;
        overflow: hidden; /* Důležité pro scrollování uvnitř */
        height: 100%;
    }

    .panel { 
        flex: 1; 
        background: var(--panel-bg); 
        border: 1px solid #222; 
        border-radius: 12px; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden; 
        min-height: 0; /* Klíčové pro Flexbox scrolling */
    }
    
    .panel-head { 
        padding: 12px 15px; 
        border-bottom: 1px solid #222; 
        background: #1a1a1a; 
        display: flex; align-items: center; 
        flex: 0 0 auto; /* Hlavička panelu se nescrolluje */
    }

    .icon-box { width: 22px; height: 22px; margin-right: 10px; }
    .icon-box svg { width: 100%; height: 100%; fill: currentColor; }
    .bus .icon-box { color: var(--accent-bus); }
    .metro .icon-box { color: var(--accent-metro); }
    .panel-title { font-weight: bold; font-size: 0.95rem; text-transform: uppercase; color: #fff; }
    
    /* SCROLLOVACÍ ČÁST */
    .list-container { 
        flex: 1; 
        overflow-y: auto; /* Zde povolíme scroll */
        -webkit-overflow-scrolling: touch; /* Plynulý scroll na iOS */
        padding: 0; 
    }

    table { width: 100%; border-collapse: collapse; }
    tr { height: 60px; border-bottom: 1px solid #222; }
    td { padding: 0 12px; vertical-align: middle; }
    tr:last-child { border-bottom: none; }
    
    .badge { 
        background: #222; color: #fff; padding: 0; border-radius: 6px; 
        font-weight: bold; font-size: 1.1rem; display: inline-block; 
        width: 48px; height: 32px; line-height: 32px; text-align: center; 
    }
    .bus .badge { background: var(--accent-bus); }
    .metro .badge { background: var(--accent-metro); }
    
    .td-dest { font-size: 1.1rem; font-weight: bold; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
    .td-time { text-align: right; width: 90px; white-space: nowrap; }
    
    .countdown-wrap { display: flex; justify-content: flex-end; align-items: baseline; }
    .val { font-size: 1.5rem; font-weight: bold; }
    .unit { font-size: 0.8rem; color: #888; margin-left: 2px; }
    .real-time { font-size: 0.85rem; color: #666; margin-top: 1px; }
    
    .sched-time { font-weight: bold; color: #ccc; }

    .status-now .val { color: var(--accent-metro); }
    .status-soon .val { color: var(--status-warn); }
    
    .delay-pill { 
        font-size: 0.7rem; font-weight: 800; color: #000; background-color: var(--status-warn);
        margin-left: 4px; padding: 1px 4px; border-radius: 3px; display: inline-block; vertical-align: middle;
    }

    #error-console { 
        position: absolute; top: 0; left: 0; width: 100%; background: #900; color: white; 
        font-size: 12px; padding: 10px; display: none; z-index: 9999; font-family: monospace; 
    }

    /* === MOBILNÍ ÚPRAVY === */
    @media (max-width: 900px) {
        body { padding: 10px; }

        header {
            flex-wrap: wrap; 
            padding-bottom: 8px;
            margin-bottom: 8px;
        }

        .header-left h1 { font-size: 0.75rem; }
        .date-large { font-size: 1.1rem; }
        
        .clock { 
            font-size: 1.4rem; /* Zmenšeno, aby se vešly i vteřiny vedle sebe */
            margin-left: auto;
        }

        .weather-wrap {
            margin-left: 10px;
            padding-left: 10px;
            border-left: 1px solid #333;
        }
        .weather-icon { width: 30px; height: 30px; margin-right: 6px; }
        .weather-temp { font-size: 1.3rem; }
        .weather-desc { display: none; } 

        .grid { 
            flex-direction: column; 
            gap: 10px;
        }

        .panel {
            flex: 1; 
            width: 100%;
        }

        @media (orientation: landscape) {
            .grid { flex-direction: row; }
            .header-left { flex-direction: row; align-items: baseline; gap: 10px; }
            .weather-desc { display: block; }
        }
    }
    
    /* Velmi malé telefony */
    @media (max-width: 360px) {
        .date-large { font-size: 1rem; }
        .clock { font-size: 1.2rem; }
        .weather-wrap { margin-left: 8px; padding-left: 8px; }
        .weather-temp { font-size: 1.1rem; }
    }
  </style>
</head>
<body>

  <div id="error-console"></div>

  <header>
    <div class="header-left">
      <h1 id="day-display">Načítám...</h1>
      <div class="header-main-info">
          <div id="date-display" class="date-large">...</div>
          
          <div class="weather-wrap" id="weather-box">
            <div id="weather-icon" class="weather-icon"></div>
            <div class="weather-text">
                <span id="weather-temp" class="weather-temp">--°</span>
                <span id="weather-desc" class="weather-desc"></span>
            </div>
          </div>
      </div>
    </div>
    <div id="clock" class="clock">--:--:--</div>
  </header>

  <div class="grid">
    <div class="panel bus">
      <div class="panel-head">
        <div class="icon-box"><svg viewBox="0 0 24 24"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg></div>
        <span class="panel-title">Litochlebské nám.</span>
        <span id="err-bus" style="display:none; color:red; margin-left:auto; font-size:0.7rem; font-weight:bold;">CHYBA</span>
      </div>
      <div class="list-container">
        <table><tbody id="tbody-bus"></tbody></table>
      </div>
    </div>

    <div class="panel metro">
      <div class="panel-head">
        <div class="icon-box"><svg viewBox="0 0 24 24"><path d="M12 2c-4.42 0-8 .5-8 4v10c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4zM7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm3.5-6H6V6h5v5zm5.5 6c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6h-5V6h5v5z"/></svg></div>
        <span class="panel-title">Metro C – Opatov</span>
        <span id="err-metro" style="display:none; color:red; margin-left:auto; font-size:0.7rem; font-weight:bold;">CHYBA</span>
      </div>
      <div class="list-container">
        <table><tbody id="tbody-metro"></tbody></table>
      </div>
    </div>
  </div>

  <script>
    // --- JS LOGIKA ---
    window.onerror = function(msg, url, line) {
       var el = document.getElementById('error-console');
       if(el) {
           el.style.display = 'block';
           el.innerText = "JS Error: " + msg;
       }
       return false;
    };

    var API_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NDE1NCwiaWF0IjoxNzYzMDQ0OTYyLCJleHAiOjExNzYzMDQ0OTYyLCJpc3MiOiJnb2xlbWlvIiwianRpIjoiYWI3ZTJlMjYtYmVjZS00MGNhLTlkYTItZGY1MzEzMjNmOTRhIn0.5P9OjGHaDP4wJ4f6w05fQZR1UARUgxk2gBuwDjpVrWU";
    var API_BASE = "https://api.golemio.cz/v2/pid/departureboards";
    var WEATHER_API = "https://api.open-meteo.com/v1/forecast?latitude=50.03&longitude=14.51&current_weather=true";
    var REFRESH_INTERVAL = 15000;
    
    var PANELS = [
      {
        id: 'bus',
        url: API_BASE + "?ids=U344Z4P&limit=20&minutesAfter=90&preferredTimezone=Europe/Prague",
        tbodyId: 'tbody-bus', 
        errElId: 'err-bus',   
        filter: function(d) { 
            if (!d.route) return false;
            var num = d.route.short_name || d.route.number;
            return ["177", "181", "182"].indexOf(num) !== -1;
        }
      },
      {
        id: 'metro',
        url: API_BASE + "?names=Opatov&limit=50&minutesAfter=90&preferredTimezone=Europe/Prague",
        tbodyId: 'tbody-metro', 
        errElId: 'err-metro',   
        filter: function(d) {
            if (!d.route || !d.trip) return false;
            return d.route.short_name === "C" && d.trip.headsign !== "Háje";
        }
      }
    ];

    var W_ICONS = {
        0: '<circle cx="12" cy="12" r="5" fill="#FDB813" /><g stroke="#FDB813" stroke-width="2"><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></g>',
        1: '<circle cx="10" cy="10" r="4" fill="#FDB813" /><path d="M18,19c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.7,19,18,19z" fill="#B0C4DE" />',
        2: '<path d="M17.5,19c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,19,17.5,19z" fill="#B0C4DE" opacity="0.8"/>',
        3: '<path d="M17.5,19c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,19,17.5,19z" fill="#9CA3AF"/>',
        61: '<path d="M17.5,17c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,17,17.5,17z" fill="#9CA3AF"/><line x1="8" y1="18" x2="7" y2="22" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="18" x2="11" y2="22" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/><line x1="16" y1="18" x2="15" y2="22" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/>',
        71: '<path d="M17.5,17c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,17,17.5,17z" fill="#B0C4DE"/><circle cx="8" cy="21" r="1.5" fill="white"/><circle cx="12" cy="20" r="1.5" fill="white"/><circle cx="16" cy="21" r="1.5" fill="white"/>',
        95: '<path d="M17.5,17c0-1.7-1.3-3-3-3c-0.4,0-0.7,0.1-1,0.3c-0.4-1.2-1.5-2-2.8-2c-1.7,0-3,1.3-3,3c0,0,0,0,0,0h-0.5c-1.9,0-3.5,1.6-3.5,3.5s1.6,3.5,3.5,3.5h10.5c1.7,0,3-1.3,3-3S19.2,17,17.5,17z" fill="#6B7280"/><polygon points="11 17 9 21 11 21 10 24 14 20 12 20 13 17" fill="#FDB813"/>'
    };

    function ajaxGet(url, token, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        if (token) {
            xhr.setRequestHeader("x-access-token", token);
            xhr.setRequestHeader("Content-Type", "application/json");
        }
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        var json = JSON.parse(xhr.responseText);
                        callback(null, json);
                    } catch (e) {
                        callback("JSON Err", null);
                    }
                } else {
                    callback("HTTP " + xhr.status, null);
                }
            }
        };
        xhr.onerror = function() { callback("Net Err", null); };
        xhr.send();
    }

    function formatHM(date) {
        var h = ("0" + date.getHours()).slice(-2);
        var m = ("0" + date.getMinutes()).slice(-2);
        return h + ":" + m;
    }

    function loadPanelData(panel) {
        var tbody = document.getElementById(panel.tbodyId);
        var errEl = document.getElementById(panel.errElId);

        ajaxGet(panel.url, API_TOKEN, function(err, data) {
            if (err) {
                if(errEl) { errEl.style.display = 'inline'; errEl.innerText = err; }
                return;
            }
            
            var raw = data.departures || [];
            var items = [];
            
            for (var i = 0; i < raw.length; i++) {
                var d = raw[i];
                try { if (!panel.filter(d)) continue; } catch(e) { continue; }

                var ts = d.departure_timestamp || {};
                var sched = ts.scheduled ? new Date(ts.scheduled) : null;
                var pred = ts.predicted ? new Date(ts.predicted) : null;
                var eff = pred || sched;
                
                if (!eff) continue;

                var line = (d.route && d.route.short_name) ? d.route.short_name : "?";
                var dest = (d.trip && d.trip.headsign) ? d.trip.headsign : "?";

                var delayHtml = "";
                if (sched && pred) {
                    var diff = Math.round((pred - sched) / 60000);
                    if (diff > 0) delayHtml = '<span class="delay-pill">+' + diff + '</span>';
                }

                items.push({
                    line: line, dest: dest,
                    schedTime: sched ? formatHM(sched) : "",
                    ts: eff.getTime(),
                    delayHtml: delayHtml
                });
            }

            items.sort(function(a, b) { return a.ts - b.ts; });
            items = items.slice(0, 30); 

            var html = "";
            if (items.length === 0) {
                html = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#666">Žádné spoje</td></tr>';
            } else {
                for (var j = 0; j < items.length; j++) {
                    var item = items[j];
                    html += '<tr data-ts="' + item.ts + '">' +
                        '<td><div class="badge">' + item.line + '</div></td>' +
                        '<td class="td-dest">' + item.dest + '</td>' +
                        '<td class="td-time">' +
                            '<div class="countdown-wrap"><span class="val">--</span><span class="unit">min</span></div>' +
                            '<div class="real-time">' + '<span class="sched-time">' + item.schedTime + '</span>' + item.delayHtml + '</div>' +
                        '</td>' +
                        '</tr>';
                }
            }
            if(tbody) {
                tbody.innerHTML = html;
                updateTimersInDom(tbody); 
            }
            if(errEl) errEl.style.display = 'none';
        });
    }

    function loadWeather() {
        ajaxGet(WEATHER_API, null, function(err, data) {
            if (err) return;
            if (data.current_weather) {
                var t = Math.round(data.current_weather.temperature);
                var elTemp = document.getElementById('weather-temp');
                if(elTemp) elTemp.innerText = t + "°";
                
                var code = data.current_weather.weathercode;
                var svg = W_ICONS[2]; 
                if (W_ICONS[code]) svg = W_ICONS[code];
                else {
                    if (code <= 1) svg = W_ICONS[0];
                    else if (code >= 51 && code <= 67) svg = W_ICONS[61];
                    else if (code >= 71 && code <= 77) svg = W_ICONS[71];
                    else if (code >= 95) svg = W_ICONS[95];
                }
                
                var elIcon = document.getElementById('weather-icon');
                if(elIcon) elIcon.innerHTML = '<svg viewBox="0 0 24 24">' + svg + '</svg>';
                
                var desc = "zataženo";
                if(code === 0) desc = "jasno";
                if(code === 1) desc = "polojasno";
                if(code > 50) desc = "srážky";
                
                var elDesc = document.getElementById('weather-desc');
                if(elDesc) elDesc.innerText = desc;
                
                var elBox = document.getElementById('weather-box');
                if(elBox) elBox.style.opacity = 1;
            }
        });
    }

    function updateTimersInDom(tbody) {
        if(!tbody) return; 
        
        var now = new Date().getTime();
        var rows = tbody.querySelectorAll('tr[data-ts]');
        for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var targetTs = parseInt(row.getAttribute('data-ts'));
            var diffSec = Math.floor((targetTs - now) / 1000);
            var valEl = row.querySelector('.val');
            var unitEl = row.querySelector('.unit');
            
            valEl.style.color = "#ffffff";

            if (diffSec < -30) {
                row.style.display = 'none';
            } else {
                row.style.display = 'table-row'; 
                var text = "";
                var unit = "";
                if (diffSec <= 0) {
                    text = "TEĎ"; valEl.style.color = "#E11D2D";
                } else {
                    var m = Math.floor(diffSec / 60);
                    var s = diffSec % 60;
                    if (m === 0) {
                        text = s; unit = "s"; valEl.style.color = "#E11D2D";
                    } else {
                        text = m; unit = "min";
                        if (m < 5) valEl.style.color = "#FFCC00"; 
                    }
                }
                valEl.innerText = text;
                unitEl.innerText = unit;
            }
        }
    }

    function tick() {
      var now = new Date();
      var elClock = document.getElementById('clock');
      if(elClock) {
          // PŘIDÁNY VTEŘINY
          elClock.innerText = now.toLocaleTimeString('cs-CZ', {
              hour: '2-digit', minute:'2-digit', second: '2-digit'
          });
      }
      
      var days = ["Neděle", "Pondělí", "Úterý", "Středa", "Čtvrtek", "Pátek", "Sobota"];
      var dayName = days[now.getDay()];
      var dateStr = now.getDate() + ". " + (now.getMonth() + 1) + ".";
      
      var elDay = document.getElementById('day-display');
      if(elDay) elDay.innerText = dayName;
      
      var elDate = document.getElementById('date-display');
      if(elDate) elDate.innerText = dateStr;

      var tbodyBus = document.getElementById('tbody-bus');
      if(tbodyBus) updateTimersInDom(tbodyBus);
      
      var tbodyMetro = document.getElementById('tbody-metro');
      if(tbodyMetro) updateTimersInDom(tbodyMetro);
    }

    function dataLoop() {
        for (var i = 0; i < PANELS.length; i++) {
            loadPanelData(PANELS[i]);
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        tick();
        dataLoop();
        loadWeather();

        setInterval(tick, 1000);
        setInterval(dataLoop, REFRESH_INTERVAL); 
        setInterval(loadWeather, 900000);
    });

  </script>
</body>
</html>
